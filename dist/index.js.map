{"version":3,"sources":["../src/index.js"],"names":["LocalStrategy","require","Strategy","RateLimit","app","server","createServer","enable","limiter","windowMs","max","delayMs","use","json","limit","bodyLimit","initialize","User","usernameField","passwordField","email","password","next","findOne","err","user","validPassword","console","log","process","nextTick","newUser","generateHash","type","coins","username","save","serializeUser","done","id","deserializeUser","findById","listen","port","address"],"mappings":"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","file":"index.js","sourcesContent":["import http from 'http';\nimport express from 'express';\nimport bodyParser from 'body-parser';\nimport mongoose from 'mongoose';\nimport passport from 'passport';\nconst LocalStrategy = require('passport-local').Strategy;\n\nimport config from './config';\nimport routes from './routes';\n\nvar RateLimit = require('express-rate-limit');\n\nlet app = express();\napp.server = http.createServer(app);\n\n// middleware\n// limiter\napp.enable('trust proxy'); // only if you're behind a reverse proxy (Heroku, Bluemix, AWS if you use an ELB, custom Nginx setup, etc) \n \nvar limiter = new RateLimit({\n  windowMs: 15*60*1000, // 15 minutes \n  max: 1000, // limit each IP to 100 requests per windowMs \n  delayMs: 0 // disable delaying - full speed until the max limit is reached \n});\n \n//  apply to all requests \napp.use(limiter);\n\n// parese application/json\napp.use(bodyParser.json({\n\tlimit: config.bodyLimit\n}));\n// passport config\napp.use(passport.initialize());\nlet User = require('./model/user');\n\npassport.use('local-login', new LocalStrategy({\n\tusernameField: 'email',\n\tpasswordField: 'password'\n},\n\tfunction(email, password, next) {\n    User.findOne({email: email}, function(err, user){\n\n      if (err) { return next(err); }\n      if (!user) { return next('Incorrect Email or Password'); } \n      \n      if (!user.validPassword(password)) {\n      \treturn next('Incorrect Email or Password');\n      }\n\n      return next(null, user);\n    });\n  }\n));\n\npassport.use('local-register', new LocalStrategy({\n\tusernameField: 'email',\n\tpasswordField: 'password'\n},\n\tfunction(email, password, next) {\n\t\tconsole.log(email +\" \"+ password)\n\t\tprocess.nextTick(function() {\n\n\t    User.findOne({email: email}, function(err, user){\n\t    \tconsole.log(user);\n\t      if (err) { \n\t      \tconsole.log(\"stops at err\");\n\t      \tnext(err); \n\t      }\n\t      if (user) {\n\t      \tconsole.log(\"stops at err\");\n       \t\tnext('Email is already used.');\n\t     } \n\n\t      var newUser = new User();\n\t      newUser.email    = email;\n\t      newUser.password = newUser.generateHash(password);\n\t      newUser.type = \"user\";\n\t      newUser.coins = 0;\n\t      newUser.username = email;\n\t      newUser.save(function(err) {\n          if (err) {\n          \tconsole.log(\"err after creation\");\n          \tconsole.log(err);\n            next(err);\n          }\n      \tconsole.log(newUser);\n      \tnext(null, newUser);\n\t      });\n\t     \n\t    });\n\n  \t});\n  }\n));\n\npassport.serializeUser(function(user, done) {\n        done(null, user.id);\n    });\npassport.deserializeUser(function(id, done) {\n        User.findById(id, function(err, user) {\n            done(err, user);\n        });\n    });\n\n// api routes v1\napp.use('/v1', routes);\n\napp.server.listen(config.port);\nconsole.log(`started the magic on port ${app.server.address().port}`);\n\nexport default app;"]}