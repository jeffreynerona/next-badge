{"version":3,"sources":["../../src/controller/host.js"],"names":["config","db","api","get","req","res","next","host","user","id","findById","params","err","event","status","json","success","message","owner","find","$exists","hosts","console","log","length","toupdate","qrupdated","Date","now","toString","qr","substr","save","end","newHost","starttime","toISOString","post","newAttend","Attend","_id"],"mappings":"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","file":"host.js","sourcesContent":["import mongoose from 'mongoose';\nimport { Router } from 'express';\nimport Event from '../model/event';\nimport Host from '../model/host';\nimport md5 from 'md5';\n\nimport { authenticate } from '../middleware/authMiddleware';\n\nexport default({ config, db }) => {\n\tlet api = Router();\n\n\n\t// for testing 'v1/host/test/:id'\n\tapi.get('/test/:id', authenticate, (req, res, next) => {\n\t\tlet host = req.user.id;\n\t\t// newEvent.name = req.body.name;\n\t\t// newEvent.description = req.body.description;\n\t\t// newEvent.category = req.body.category;\n\t\t// newEvent.location = req.body.location;\n\t\t// newEvent.starttime = new Date(req.body.starttime);\n\t\t// newEvent.endtime = new Date(req.body.endtime);\n\t\t// newEvent.image = req.body.image;\n\t\t// newEvent.owner = req.user.id;\n\t\tEvent.findById(req.params.id, (err, event) => {\n\t\t\tif (err) {\n\t\t\t\tres.status(422).json({\n\t\t\t\t\tsuccess: false,\n\t\t\t\t\tmessage: err.message\n\t\t\t\t});\n\t\t\t} else {\n\t\t\t\tif(event.owner == host) {\n\t\t\t\t\t// host part\n\t\t\t\t\tHost.find({\n\t\t\t\t\t\t\"event\" : req.params.id,\n\t\t\t\t\t\t\"endtime\" : { $exists: false }\n\t\t\t\t\t}, (err, hosts) => {\n\t\t\t\t\t\tif (err) {\n\t\t\t\t\t\t\tres.status(200).json({\n\t\t\t\t\t\t\t\tsuccess: false,\n\t\t\t\t\t\t\t\tmessage: 'nothing found',\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tconsole.log('search host success');\n\t\t\t\t\t\t\tif(hosts.length>=1) {\n\t\t\t\t\t\t\t\t//found an active host\n\t\t\t\t\t\t\t\t//generate qr shit and connect the sockiets(happens in client)\n\t\t\t\t\t\t\t\tvar toupdate = hosts[hosts.length-1];\n\t\t\t\t\t\t\t\tvar qrupdated = Date.now().toString();\n\t\t\t\t\t\t\t\tvar qr = md5(event.id.toString() + qrupdated);\n\t\t\t\t\t\t\t\tqr = qr.substr(qr.length - 5);\n\t\t\t\t\t\t\t\ttoupdate.save(err => {\n\t\t\t\t\t\t\t\t\tif (err) {\n\t\t\t\t\t\t\t\t\t\tres.status(422).json({\n\t\t\t\t\t\t\t\t\t\t\tsuccess: false,\n\t\t\t\t\t\t\t\t\t\t\tmessage: err.message\n\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\t\tres.status(200).json({\n\t\t\t\t\t\t\t\t\t\t\tsuccess: true,\n\t\t\t\t\t\t\t\t\t\t\tmessage: 'Regenerated QR',\n\t\t\t\t\t\t\t\t\t\t\tqr: qr\n\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t// res.status(200).json({\n\t\t\t\t\t\t\t\t// \tsuccess: true,\n\t\t\t\t\t\t\t\t// \thosts: hosts[hosts.length-1]\n\t\t\t\t\t\t\t\t// \t});\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\t//no active host, create one\n\t\t\t\t\t\t\t\tvar now = new Date();\n\t\t\t\t\t\t\t\tvar end = now;\n\t\t\t\t\t\t\t\tvar qrupdated = Date.now().toString();\n\t\t\t\t\t\t\t\tvar qr = md5(event.id.toString() + qrupdated);\n\t\t\t\t\t\t\t\tqr = qr.substr(qr.length - 5);\n\t\t\t\t\t\t\t\t// end.setHours(end.getHours() + 12);\n\t\t\t\t\t\t\t\tlet newHost = new Host();\n\t\t\t\t\t\t\t\tnewHost.event = event.id;\n\t\t\t\t\t\t\t\tnewHost.host = event.owner;\n\t\t\t\t\t\t\t\tnewHost.starttime = now.toISOString();\n\t\t\t\t\t\t\t\tnewHost.qr = qr;\n\t\t\t\t\t\t\t\tnewHost.save(err => {\n\t\t\t\t\t\t\t\t\tif (err) {\n\t\t\t\t\t\t\t\t\t\tres.status(422).json({\n\t\t\t\t\t\t\t\t\t\t\tsuccess: false,\n\t\t\t\t\t\t\t\t\t\t\tmessage: err.message\n\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\t\tres.status(200).json({\n\t\t\t\t\t\t\t\t\t\t\tsuccess: true,\n\t\t\t\t\t\t\t\t\t\t\tmessage: 'Hosting',\n\t\t\t\t\t\t\t\t\t\t\tqr: newHost.qr\n\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\n\t\t\t\t\t//end host\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\treturn res.status(401).json({\n\t\t\t\t\t\tsuccess: false,\n\t\t\t\t\t\tmessage: 'Not Authorized.'\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t});\n\n\t// list of hosts - for testing /v1/host\n\tapi.get('/', (req,res) => {\n\t\tHost.find({}, (err, hosts) => {\n\t\t\tif (err) {\n\t\t\t\tres.status(422).json({\n\t\t\t\t\tsuccess: false,\n\t\t\t\t\tmessage: err.message\n\t\t\t\t});\n\t\t\t} else {\n\t\t\t\tres.status(200).json(hosts);\n\t\t\t}\n\t\t});\n\t});\n\n\t// 'v1/host/id'\n\tapi.get('/:id', authenticate, (req, res, next) => {\n\t\tlet host = req.user.id;\n\t\t// newEvent.name = req.body.name;\n\t\t// newEvent.description = req.body.description;\n\t\t// newEvent.category = req.body.category;\n\t\t// newEvent.location = req.body.location;\n\t\t// newEvent.starttime = new Date(req.body.starttime);\n\t\t// newEvent.endtime = new Date(req.body.endtime);\n\t\t// newEvent.image = req.body.image;\n\t\t// newEvent.owner = req.user.id;\n\t\tEvent.findById(req.params.id, (err, event) => {\n\t\t\tif (err) {\n\t\t\t\tres.status(422).json({\n\t\t\t\t\tsuccess: false,\n\t\t\t\t\tmessage: err.message\n\t\t\t\t});\n\t\t\t} else {\n\t\t\t\tif(event.owner == host) {\n\n\t\t\t\t\t// 1. host.find(eventid) where end is not set\n\t\t\t\t\t// 2. if found, generate na ng qr and socket connect\n\t\t\t\t\t// 3. else, new host session., then back to step 2\n\t\t\t\t\t// may button pala sa host page na pwede i stop yung host, mag lagay lang ng end time.\n\n\t\t\t\t\tvar now = new Date();\n\t\t\t\t\tvar end = now;\n\t\t\t\t\tvar qr = md5(event.id.toString() + Date.now().toString());\n\t\t\t\t\tqr = qr.substr(qr.length - 5);\n\t\t\t\t\t// end.setHours(end.getHours() + 12);\n\t\t\t\t\tlet newHost = new Host();\n\t\t\t\t\tnewHost.event = event.id;\n\t\t\t\t\tnewHost.host = event.owner;\n\t\t\t\t\tnewHost.starttime = now.toISOString();\n\t\t\t\t\tnewHost.qr = qr;\n\t\t\t\t\tnewHost.save(err => {\n\t\t\t\t\t\tif (err) {\n\t\t\t\t\t\t\tres.status(422).json({\n\t\t\t\t\t\t\t\tsuccess: false,\n\t\t\t\t\t\t\t\tmessage: err.message\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tres.status(200).json({\n\t\t\t\t\t\t\t\tsuccess: true,\n\t\t\t\t\t\t\t\tmessage: 'Hosting',\n\t\t\t\t\t\t\t\tqr: newHost.qr\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\treturn res.status(401).json({\n\t\t\t\t\t\tsuccess: false,\n\t\t\t\t\t\tmessage: 'Not Authorized.'\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t});\n\n\t// // '/v1/event/' - read\n\t// api.get('/', (req,res) => {\n\t// \tEvent.find({}, (err, events) => {\n\t// \t\tif (err) {\n\t// \t\t\tres.status(422).json({\n\t// \t\t\t\tsuccess: false,\n\t// \t\t\t\tmessage: err.message\n\t// \t\t\t});\n\t// \t\t} else {\n\t// \t\t\tres.status(200).json(events);\n\t// \t\t}\n\t// \t});\n\t// });\n\n\t// '/v1/event/add/:id attend\n\tapi.post('/add/:id', authenticate, (req,res) => {\n\t\tEvent.findById(req.params.id, (err, event) => {\n\t\t\tif (err) {\n\t\t\t\tres.status(422).json({\n\t\t\t\t\tsuccess: false,\n\t\t\t\t\tmessage: err.message\n\t\t\t\t});\n\t\t\t} else if (!event){\n\t\t\t\t\treturn res.status(404).json({\n\t\t\t\t\t\tsuccess: false,\n\t\t\t\t\t\tmessage: 'Not Found.'\n\t\t\t\t\t});\n\t\t\t} else {\n\t\t\t\tlet newAttend = new Attend();\n\t\t\t\tnewAttend.user = req.user.id;\n\t\t\t\tnewAttend.event = event._id;\n\t\t\t\tnewAttend.save((err, event) => {\n\t\t\t\t\tif (err) {\n\t\t\t\t\t\tres.status(422).json({\n\t\t\t\t\t\t\tsuccess: false,\n\t\t\t\t\t\t\tmessage: err.message\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\tres.status(200).json({\n\t\t\t\t\t\tsuccess: true,\n\t\t\t\t\t\tmessage: 'Attendee Saved!'\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\t});\n\n\treturn api;\n}"]}